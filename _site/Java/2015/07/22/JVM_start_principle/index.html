
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	
	<title>JVM启动工作原理</title>
    
	
	<meta name="author" content="Feng Ling">
	
	<link rel="stylesheet" href="/assets/themes/Snail/css/jquery.fancybox.css">
	<link rel="stylesheet" href="/assets/themes/Snail/css/main.css">
	<link rel="stylesheet" href="/assets/themes/Snail/css/pages/journal.css">
	<link rel="stylesheet" href="/assets/themes/Snail/css/team.css">
	<link rel="stylesheet" href="/assets/themes/Snail/css/static.css">
	<link rel="stylesheet" href="/assets/themes/Snail/css/errors.css">
	<link rel="stylesheet" href="/assets/themes/Snail/google-code-prettify/prettify.css">
	
	<link rel="shortcut icon" href="/assets/themes/Snail/img/1.jpeg">
	
	<script type="text/javascript" src="/assets/themes/Snail/js/jquery.min.js"></script>
	
	<script type="text/javascript" src="/assets/themes/Snail/js/auto_loadmore.js"></script>
	
	<script type="text/javascript" src="/assets/themes/Snail/google-code-prettify/prettify.js"></script>
	
	<script type="text/javascript">
	  $(function(){
		$("pre code").addClass("prettyprint linenums");
		prettyPrint();
	  });
	</script>
	
<!--[if lt IE 9]>
	<script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->

<!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">
</head>
<body>
	<noscript>
		&amp;lt;div id="no-js"&amp;gt;Please enable JavaScript in your browser to experience / fully&amp;lt;/div&amp;gt;
	</noscript>
    <div id="page-container">
		<div>
			<nav>
	<div id="nav-l">
	</div>
	<div id="nav-c">
		<ul id="nav-list" style="width: 700px;">
			<li id="home"><a href="/">Home</a></li>
			
			
			
				
				  
				
			 
				
				  
				
			 
				
				  
					
					<li id = "Categories"><a href="/categories.html">Categories</a></li>
					
				  
				
			 
				
			 
				
				  
				
			 
				
				  
				
			 
				
				  
					
					<li id = "About Me"><a href="/about.html">About Me</a></li>
					
				  
				
			 
				
				  
					
					<li id = "Archive"><a href="/archive.html">Archive</a></li>
					
				  
				
			 
				
				  
				
			 
				
				  
					
					<li id = "Tags"><a href="/tags.html">Tags</a></li>
					
				  
				
			 
				
			 
				
			 
			
			
		</ul>
		<form id="nav-search" method="GET" action="/search.html">
			<div id="search-right-pix">
				<div id="search-left-pix">
					<div id="search-center-pix">
						<div id="search-icon-pix"></div>
						<input name="query" type="text" placeholder="Search">
					</div>
				</div>
			</div>
		</form>
		
		
	</div>
	<div id="nav-r">
	</div>
</nav>
			<div id="page-content">
				
<div id="page-content">
	<div class="cont932">
	<div id="journal-articles-block">
		<div class="journal-article">
			<div class="journal-post-info">
				<div class="journal-cat-box">
				
				
				<div class="journal-cat-box">

<a href="/categories.html#Java-ref" title="Java">
	Java

</a>
</div>
				
				</div>
			</div>
			<div class="journal-body">
				<h1 class="journal-title">JVM启动工作原理<span class="author">by Mastery</span>
				</h1>
				<span class="the-article">
				<pre><code>1. JVM体系结构
2. JVM的生命周期
3. JVM启动
    3.1 JVM启动代码分析
</code></pre>

<!--more-->

<h1 id="jvm">1. JVM体系结构</h1>

<pre><code>(1)类加载器（`ClassLoader`）（用来装载`.class`文件）

(2)执行引擎（执行字节码，或者执行本地方法）

(3)运行时数据区（方法区、堆、java栈、本地方法栈、PC寄存器）
</code></pre>

<h1 id="jvm-1">2. JVM的生命周期</h1>

<p>1.JVM实例对应了一个独立运行的java程序，它是进程级别;</p>

<pre><code>a）启动。启动一个java程序时，一个JVM实例就产生了，任何一个拥有`public static void main(String
[] args)`方法的class都可以作为JVM实例运行的起点

b）运行。`main()`作为该程序的初始线程的起点，任何其他线程均由该线程启动。JVM内部有两种线程：守护线
程和非守护线程，`main()`属于非守护线程守护线程通常由JVM自己使用，java程序也可以标明自己创建的线程
是守护线程

c）消亡。当程序中的所有非守护线程都终止时，JVM才退出；若安全管理器允许，程序也可以使用`Runtime`类
或者`System.exit()`来退出
</code></pre>

<p>2.JVM执行引擎实例则对应了属于用户运行程序的线程，它是线程级别的;</p>

<h1 id="jvm-2">3. JVM启动</h1>

<p>JVM工作原理和特点主要是指操作系统装入JVM，是通过JDK中<code>java.exe</code>来完成，通过下面4步来完成JVM环境.</p>

<pre><code>1.创建`JVM`装载环境和配置

2.装载`JVM.dll`

3.初始化`JVM.dll`并挂界到`JNIENV`(`JNI`调用接口)实例

4.调用`JNIENV`实例装载并处理`class`类
</code></pre>

<h2 id="section">3.1 启动代码分析</h2>

<p><code>main</code>函数在<code>openjdk\jdk\src\share\bin\main.c</code>文件中。简单流程分析如下：</p>

<pre><code>1.SelectVersion-&gt;LocateJRE,定位jre的位置。因为在不同的操作系统上定位jre的方式不同，相关代码就
和平台相关了，windows相关的一些代码在`openjdk\jdk\src\windows`下，而`linux`和`solaris`相关
代码在`openjdk\jdk\src\solaris`下。这部分调用到的代码都在`{os}\bin\java_md.c`中。简单的说，
windows中，LocateJRE要通过查找注册表来定位jre的位置，而Linux下可能需要读取环境变量等。

2.CreateExecutionEnvironment-&gt;GetJVMPath得到jvm的路径，其实就是找到相应的动态链接
库，具体到linux上，就是`libjvm.so`。

3.LoadJavaVM，linux上是加载'libjvm.so',windows上是加载`jvm.dll`，导
出`JNI_CreateJavaVM`、`JNI_GetDefaultJavaVMInitArgs`等函数。

4.获取classpath。

5.ContinueInNewThread(&amp;ifn,argc,argv,jarfile,classname,ret);在一个新线程中启动jvm。
ContinueInNewThread的功能是：调用`GetDefaultJavaJVMInitArgs`(其实就
调用`JNI_GetDefaultJavaVMInitArgs`)获取虚拟机初始化参数，设定线程栈的大小，
创建java程序需要的各项参数。然后调用下面函数 `ContinueInNewThread0(JavaMain, 
threadStackSize, (void*)&amp;args);` ;因为不同操作系统创建线程的方式不同，所以又进
入os相关的代码，`{os}\bin\java_md.c`中的`int ContinueInNewThread0(JNICALL 
*continuation)(void *), jlong stack_size,void *args)`函数。
    
    阅读其源码，可知linux上是通过`pthread_create`创建线程，Solaris通过`thr_create`创建线程，
    而`windows`则通过`_beginthreadex`创建线程。
    
    在新线程中调用JavaMain函数，即openjdk\jdk\src\share\bin\main.c中的 `int JNICALL 
    JavaMain(void *_args)`,它负责加载要运行的的java class，并调用class的main方法。
    
    处理步骤是：
    
    1).InitalizeJVM-&gt;CreateJavaVM(即通过JNI调用JNI_CreateJavaVM),创建jvm。
    2).LoadMainClass加载main class，并确保main方法的签名是正确的。 
    3).mainID = (*env)-&gt;GetStaticMethodID(env, mainClass, "main","([Ljava/lang/String;)V");通过JNI得到main方法的method信息。 
    4).mainArgs = NewPlatformStringArray(env, argv, argc);为main方法准备参数数组。 
    5).(*env)-&gt;CallStaticVoidMethod(env, mainClass, mainID, mainArgs);通过JNI调用main方法。 
    6).ret = (*env)-&gt;ExceptionOccurred(env) == NULL ? 0 : 1;处理异常 
    7).DetachCurrentThread 
    8).DestroyJavaVM 销毁JVM
</code></pre>

<blockquote>
  <p>下面以windows的实现进行分析：</p>

  <p>首先查找jre路径，Java通过<code>GetApplicationHome api</code>来获得当前的<code>java.exe</code>绝对路径（例如我电脑上的<code>e:\program
\java\jdk\bin\java.exe</code>），那么它会截取到绝对路径<code>e:\program\java\jdk</code>，判断<code>e:\program\java\jdk\jvm.dll</code>
文件是否存在，如果存在就把<code>e:\program\java\jdk</code>，作为jre路径；如果不存在则判断<code>e:\program\java\jdk\jre\jvm.dll</code>
是否存在，如果存在则将<code>e:\program\java\jdk\jre</code>作为jre路径。如果不存在调用<code>GetPublicJREHome</code>查<code>HKEY_LOCAL
_MACHINE\Software\JavaSoft\Java Runtime Environment\"当前JRE版本号"\JavaHome</code>的路径作为jre路径。</p>
</blockquote>


				</span>
				<div class="journal-date">Published 22 July 2015</div>
				<div class="journal-tags">
				
				
	 
		<a class="tag-cont" href="/tags.html#Java-ref">
			<div class="tag-l"></div>
			<div class="tag-c">Java</div>
			<div class="tag-r"></div>
		</a>
	



				</div>
			</div>
		</div>
		<div class="clearboth"></div>
	</div>
</div>
	<div class="clearboth"></div>
        


  <div id="comments">
    <div class="ds-thread" data-thread-key="/Java/2015/07/22/JVM_start_principle"  data-title="JVM启动工作原理 - Dolphin"></div>
</div>
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"mastery"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>





	<div class="clearboth"></div>
</div>


			</div>
			<div class="clearboth pagebottom"></div>
		</div>
	</div>
	<footer>
	<div class="footer-940">
		<div class="footer-general-info">
			© 2014 Feng Ling.<br><br>
			Content licensed under:<br>
			<a class="cc" href="http://creativecommons.org/licenses/by-sa/3.0/">c a b</a><br>
			<a href = "/about.html">About Me</a><br>
		</div>
		<div class="footer-col-cont">
			<div class="footer-nav-col">
				<h4><a>Categories</a></h4>
				<ul>
					
					


  
     
    	<li><a href="/categories.html#DataStructure-ref">
    		DataStructure <span>1</span>
    	</a></li>
     
    	<li><a href="/categories.html#Java-ref">
    		Java <span>4</span>
    	</a></li>
     
    	<li><a href="/categories.html#Notes-ref">
    		Notes <span>1</span>
    	</a></li>
     
    	<li><a href="/categories.html#Maven-ref">
    		Maven <span>2</span>
    	</a></li>
     
    	<li><a href="/categories.html#Spring-ref">
    		Spring <span>1</span>
    	</a></li>
     
    	<li><a href="/categories.html#Testing-ref">
    		Testing <span>1</span>
    	</a></li>
    
  


				</ul>
			</div>
			<div class="footer-nav-col">
				<h4><a>Pages</a></h4>
				<ul>
					
					
					


  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/categories.html">Categories</a></li>
      	
      
    
  
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/about.html">About Me</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/archive.html">Archive</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags.html">Tags</a></li>
      	
      
    
  
    
  
    
  



				</ul>
			</div>
			<div class="footer-nav-col">
				<h4><a>Feed</a></h4>
				<ul>
					<li><a href="/atom.xml">Atom Feed</a></li>
					<li><a href="/rss.xml">RSS Feed</a></li>
				</ul>
			</div>
			<div class="footer-nav-col">
				<h4><a>Links</a></h4>
				<ul>
				 
					<li><a href = "http://mastery001.github.io/">Mastery's Blog</a></li>
				
				</ul>
			</div>
			<div class="footer-nav-col">
				<h4><a href = "/about.html">About Me</a></h4>
				<ul>
				 
					<li><a href = "mailto:zlfbasic@gmail.com">e-mail</a></li>
				 
					<li><a href = "https://github.com/mastery001">Github</a></li>
				 
					<li><a href = "https://plus.google.com/u/0/">Google+</a></li>
				
				</ul>
			</div>
			<div class="clearboth"></div>
		</div>
		<div class="clearboth"></div>
	</div>
	<div class="clearboth"></div>
</footer>
	
</body>
</html>

